{% extends "base.html" %}

{% block content %}
<!-- Phone Call Full Screen - Matching Project Theme -->
<div id="call-screen" class="fixed inset-0 z-50 bg-surface flex flex-col overflow-hidden">
    
    <!-- Subtle Background Accent -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-1/4 left-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-primary/5 rounded-full blur-3xl animate-pulse"></div>
        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-tertiary/5 rounded-full blur-3xl"></div>
    </div>

    <!-- Header: Status & Timer -->
    <div class="relative z-10 pt-safe px-6 pt-12 text-center">
        <p id="call-status" class="text-onSurfaceVariant text-sm font-medium tracking-wide uppercase">Not Connected</p>
        <p id="call-timer" class="text-onSurfaceVariant/60 text-xs font-mono mt-1 hidden">00:00</p>
    </div>

    <!-- Main Content: Avatar & Info -->
    <div class="flex-1 flex flex-col items-center justify-center relative z-10 px-6">
        
        <!-- Avatar with Sound Animation -->
        <div class="relative mb-8">
            <!-- Listening/Speaking Rings -->
            <div id="ring-1" class="absolute inset-[-15px] rounded-full border-2 border-white/0 transition-all duration-500"></div>
            <div id="ring-2" class="absolute inset-[-30px] rounded-full border border-white/0 transition-all duration-500"></div>
            <div id="ring-3" class="absolute inset-[-45px] rounded-full border border-white/0 transition-all duration-500"></div>
            
            <!-- Main Avatar -->
            <div id="avatar-container" class="relative h-32 w-32 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 shadow-2xl shadow-purple-500/30 flex items-center justify-center transition-transform duration-500">
                <span id="avatar-icon" class="material-symbols-rounded text-5xl text-white">smart_toy</span>
            </div>
        </div>

        <!-- Name & Subtitle -->
        <h1 class="text-onSurface text-2xl font-bold tracking-tight">AI English Coach</h1>
        <p id="subtitle" class="text-onSurfaceVariant text-sm mt-1">Your personal tutor</p>

        <!-- Live Captions -->
        <div id="captions-area" class="mt-10 w-full max-w-md min-h-[120px] px-4">
            <div id="user-caption" class="text-right mb-3 opacity-0 transition-opacity duration-300">
                <span class="inline-block bg-surfaceVariant text-onSurfaceVariant px-4 py-2 rounded-2xl rounded-tr-sm text-sm"></span>
            </div>
            <div id="ai-caption" class="text-left opacity-0 transition-opacity duration-300">
                <span class="inline-block bg-primaryContainer text-onPrimaryContainer px-4 py-2 rounded-2xl rounded-tl-sm text-sm"></span>
            </div>
        </div>
    </div>

    <!-- Bottom Controls -->
    <div class="relative z-10 pb-12 pt-6 px-8">
        
        <!-- Pre-Call: Start Button -->
        <div id="pre-call-controls" class="flex justify-center">
            <button id="start-call-btn" class="h-20 w-20 rounded-full bg-primary hover:bg-primary/90 text-onPrimary shadow-lg shadow-primary/30 flex items-center justify-center transition-all duration-300 active:scale-95 hover:scale-105">
                <span class="material-symbols-rounded text-4xl">call</span>
            </button>
        </div>

        <!-- In-Call Controls -->
        <div id="in-call-controls" class="hidden">
            <div class="flex items-center justify-center gap-6">
                <!-- Mute -->
                <button id="mute-btn" class="h-14 w-14 rounded-full bg-surfaceVariant text-onSurfaceVariant flex items-center justify-center transition-all duration-200 active:scale-95 hover:bg-surfaceVariant/80">
                    <span id="mute-icon" class="material-symbols-rounded text-2xl">mic</span>
                </button>

                <!-- End Call -->
                <button id="end-call-btn" class="h-20 w-20 rounded-full bg-error hover:bg-error/90 text-onError shadow-lg shadow-error/30 flex items-center justify-center transition-all duration-300 active:scale-95">
                    <span class="material-symbols-rounded text-4xl">call_end</span>
                </button>

                <!-- Speaker -->
                <button id="speaker-btn" class="h-14 w-14 rounded-full bg-surfaceVariant text-onSurfaceVariant flex items-center justify-center transition-all duration-200 active:scale-95 hover:bg-surfaceVariant/80">
                    <span id="speaker-icon" class="material-symbols-rounded text-2xl">volume_up</span>
                </button>
            </div>

            <!-- Voice Activity Indicator -->
            <div class="flex justify-center mt-6 gap-1">
                <div id="bar-1" class="w-1 h-3 bg-outline/30 rounded-full transition-all duration-100"></div>
                <div id="bar-2" class="w-1 h-3 bg-outline/30 rounded-full transition-all duration-100"></div>
                <div id="bar-3" class="w-1 h-3 bg-outline/30 rounded-full transition-all duration-100"></div>
                <div id="bar-4" class="w-1 h-3 bg-outline/30 rounded-full transition-all duration-100"></div>
                <div id="bar-5" class="w-1 h-3 bg-outline/30 rounded-full transition-all duration-100"></div>
            </div>
            <p id="voice-hint" class="text-center text-onSurfaceVariant/60 text-xs mt-2">Speak now...</p>
        </div>
    </div>

    <!-- Settings Button -->
    <button id="settings-btn" class="absolute top-12 right-6 z-20 p-2 rounded-full bg-surfaceVariant/50 text-onSurfaceVariant hover:bg-surfaceVariant transition-colors">
        <span class="material-symbols-rounded text-xl">settings</span>
    </button>

    <!-- Back Button -->
    <a href="{% url 'home' %}" class="absolute top-12 left-6 z-20 p-2 rounded-full bg-surfaceVariant/50 text-onSurfaceVariant hover:bg-surfaceVariant transition-colors">
        <span class="material-symbols-rounded text-xl">arrow_back</span>
    </a>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="modal-backdrop"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
        <div class="relative rounded-3xl bg-[#1e1e2e] border border-white/10 shadow-2xl w-full max-w-sm">
            <div class="px-6 py-6">
                <h3 class="text-lg font-bold text-white mb-6">Voice Settings</h3>
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-purple-400 uppercase tracking-wider mb-2">Voice</label>
                        <select id="voice-select" class="block w-full rounded-xl border-0 bg-white/10 py-3 pl-4 pr-10 text-white ring-1 ring-white/10 focus:ring-2 focus:ring-purple-500 text-sm"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-purple-400 uppercase tracking-wider mb-2">Speed: <span id="rate-value" class="text-white">1.0</span>x</label>
                        <input type="range" id="rate-range" min="0.5" max="2" step="0.1" value="1" class="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer accent-purple-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-purple-400 uppercase tracking-wider mb-2">Pitch: <span id="pitch-value" class="text-white">1.0</span></label>
                        <input type="range" id="pitch-range" min="0.5" max="2" step="0.1" value="1" class="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer accent-purple-500">
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 flex gap-3 border-t border-white/10">
                <button id="test-voice" class="flex-1 px-4 py-2.5 rounded-full bg-white/10 text-white text-sm font-bold hover:bg-white/20 transition-colors">Test Voice</button>
                <button id="save-settings" class="flex-1 px-4 py-2.5 rounded-full bg-purple-500 text-white text-sm font-bold hover:bg-purple-400 transition-colors">Done</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ===== Elements =====
    const $ = id => document.getElementById(id);
    
    const callStatus = $('call-status');
    const callTimer = $('call-timer');
    const subtitle = $('subtitle');
    const avatarContainer = $('avatar-container');
    const avatarIcon = $('avatar-icon');
    const rings = [$('ring-1'), $('ring-2'), $('ring-3')];
    const bars = [$('bar-1'), $('bar-2'), $('bar-3'), $('bar-4'), $('bar-5')];
    const voiceHint = $('voice-hint');
    
    const userCaption = $('user-caption').querySelector('span');
    const aiCaption = $('ai-caption').querySelector('span');
    const userCaptionWrap = $('user-caption');
    const aiCaptionWrap = $('ai-caption');
    
    const preCallControls = $('pre-call-controls');
    const inCallControls = $('in-call-controls');
    const startCallBtn = $('start-call-btn');
    const endCallBtn = $('end-call-btn');
    const muteBtn = $('mute-btn');
    const muteIcon = $('mute-icon');
    const speakerBtn = $('speaker-btn');
    const speakerIcon = $('speaker-icon');

    // ===== State =====
    let state = 'idle';
    let conversationId = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let voices = [];
    let isMuted = false;
    let isSpeakerOn = true;
    let callStartTime = null;
    let timerInterval = null;
    let silenceTimer = null;
    let analyserInterval = null;
    let audioContext = null;
    let analyser = null;
    let mediaStream = null;

    const SILENCE_THRESHOLD = 2500;

    // ===== Call Management =====
    async function startCall() {
        try {
            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(mediaStream);
            source.connect(analyser);
            analyser.fftSize = 256;
            
            callStartTime = Date.now();
            callTimer.classList.remove('hidden');
            timerInterval = setInterval(updateTimer, 1000);
            
            preCallControls.classList.add('hidden');
            inCallControls.classList.remove('hidden');
            
            startListening();
            
        } catch (err) {
            console.error('Mic error:', err);
            callStatus.textContent = 'Microphone access denied';
        }
    }

    function endCall() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
        if (mediaStream) {
            mediaStream.getTracks().forEach(t => t.stop());
        }
        if (audioContext) {
            audioContext.close();
        }
        window.speechSynthesis.cancel();
        clearInterval(timerInterval);
        clearInterval(analyserInterval);
        clearTimeout(silenceTimer);
        
        conversationId = null;
        callStartTime = null;
        state = 'idle';
        
        callStatus.textContent = 'Call Ended';
        callTimer.classList.add('hidden');
        preCallControls.classList.remove('hidden');
        inCallControls.classList.add('hidden');
        userCaptionWrap.style.opacity = '0';
        aiCaptionWrap.style.opacity = '0';
        stopRings();
        resetBars();
        
        setTimeout(() => {
            callStatus.textContent = 'Not Connected';
            subtitle.textContent = 'Your personal tutor';
        }, 2000);
    }

    function updateTimer() {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const secs = (elapsed % 60).toString().padStart(2, '0');
        callTimer.textContent = `${mins}:${secs}`;
    }

    // ===== Voice Activity Detection & Recording =====
    function startListening() {
        if (isMuted) {
            callStatus.textContent = 'Muted';
            voiceHint.textContent = 'Unmute to speak';
            return;
        }

        state = 'listening';
        callStatus.textContent = 'Listening';
        voiceHint.textContent = 'Speak now...';
        avatarIcon.textContent = 'hearing';
        avatarContainer.className = 'relative h-32 w-32 rounded-full bg-gradient-to-br from-primary to-secondary shadow-2xl shadow-primary/30 flex items-center justify-center transition-transform duration-500';
        startRings('listening');
        
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
            ? 'audio/webm;codecs=opus' 
            : 'audio/webm';
        
        mediaRecorder = new MediaRecorder(mediaStream, { mimeType });
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) audioChunks.push(e.data);
        };
        
        mediaRecorder.onstop = () => {
            if (audioChunks.length > 0 && state !== 'idle') {
                const blob = new Blob(audioChunks, { type: mimeType });
                sendAudio(blob, mimeType.split(';')[0]);
            }
        };
        
        mediaRecorder.start();
        startVoiceMonitor();
    }

    function startVoiceMonitor() {
        let lastSoundTime = Date.now();
        let hasSpoken = false;
        
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        analyserInterval = setInterval(() => {
            analyser.getByteFrequencyData(dataArray);
            const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
            
            updateBars(average);
            
            if (average > 30) {
                lastSoundTime = Date.now();
                hasSpoken = true;
                clearTimeout(silenceTimer);
            } else if (hasSpoken && Date.now() - lastSoundTime > SILENCE_THRESHOLD) {
                clearInterval(analyserInterval);
                stopRecording();
            }
        }, 100);
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            setState('processing');
        }
    }

    function updateBars(level) {
        const normalizedLevel = Math.min(level / 50, 1);
        bars.forEach((bar, i) => {
            const height = 3 + Math.random() * normalizedLevel * 20;
            bar.style.height = `${height}px`;
            bar.style.backgroundColor = normalizedLevel > 0.3 ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-outline)';
        });
    }

    function resetBars() {
        bars.forEach(bar => {
            bar.style.height = '12px';
            bar.style.backgroundColor = 'var(--md-sys-color-outline)';
        });
    }

    // ===== API =====
    async function sendAudio(blob, mimeType) {
        setState('processing');
        
        try {
            const base64 = await blobToBase64(blob);
            
            const response = await fetch('/voice-chat-api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    audio: base64,
                    mime_type: mimeType,
                    conversation_id: conversationId
                })
            });
            
            if (!response.ok) throw new Error('API Error');
            const data = await response.json();
            
            if (data.conversation_id) conversationId = data.conversation_id;
            
            aiCaption.textContent = data.response;
            aiCaptionWrap.style.opacity = '1';
            
            speak(data.response);
            
        } catch (err) {
            console.error('API Error:', err);
            callStatus.textContent = 'Connection error';
            setTimeout(() => startListening(), 2000);
        }
    }

    function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    // ===== Text-to-Speech =====
    function speak(text) {
        if (!window.speechSynthesis || !isSpeakerOn || !text) {
            setTimeout(() => startListening(), 500);
            return;
        }
        
        setState('speaking');
        
        // Simple approach - no workarounds
        const msg = new SpeechSynthesisUtterance();
        msg.text = text;
        msg.rate = parseFloat(localStorage.getItem('speechRate')) || 1.0;
        msg.pitch = parseFloat(localStorage.getItem('speechPitch')) || 1.0;
        msg.volume = 1.0;
        
        // Set voice if saved
        const voiceURI = localStorage.getItem('voiceURI');
        if (voiceURI && voices.length > 0) {
            const voice = voices.find(v => v.voiceURI === voiceURI);
            if (voice) msg.voice = voice;
        }
        
        msg.onend = function() {
            startListening();
        };
        
        msg.onerror = function(e) {
            console.log('Speech error:', e);
            startListening();
        };
        
        // Speak directly
        speechSynthesis.cancel();
        speechSynthesis.speak(msg);
    }

    // ===== State Management =====
    function setState(newState) {
        state = newState;
        
        switch (newState) {
            case 'listening':
                callStatus.textContent = 'Listening';
                voiceHint.textContent = 'Speak now...';
                avatarIcon.textContent = 'hearing';
                avatarContainer.className = 'relative h-32 w-32 rounded-full bg-gradient-to-br from-primary to-secondary shadow-2xl shadow-primary/30 flex items-center justify-center transition-transform duration-500';
                startRings('listening');
                break;
                
            case 'processing':
                callStatus.textContent = 'Processing';
                voiceHint.textContent = 'Understanding...';
                avatarIcon.textContent = 'psychology';
                avatarContainer.className = 'relative h-32 w-32 rounded-full bg-gradient-to-br from-tertiary to-secondary shadow-2xl shadow-tertiary/30 flex items-center justify-center transition-transform duration-500 animate-pulse';
                stopRings();
                resetBars();
                break;
                
            case 'speaking':
                callStatus.textContent = 'AI Speaking';
                voiceHint.textContent = 'Listening...';
                avatarIcon.textContent = 'record_voice_over';
                avatarContainer.className = 'relative h-32 w-32 rounded-full bg-gradient-to-br from-primary to-tertiary shadow-2xl shadow-primary/30 flex items-center justify-center transition-transform duration-500';
                startRings('speaking');
                break;
        }
    }

    // ===== Visual Effects =====
    let ringInterval = null;
    
    function startRings(type) {
        stopRings();
        const color = type === 'listening' ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-tertiary)';
        let scale = 0;
        
        ringInterval = setInterval(() => {
            scale = (scale + 1) % 3;
            rings.forEach((ring, i) => {
                const s = 1 + ((scale + i) % 3) * 0.15;
                const o = 1 - ((scale + i) % 3) * 0.3;
                ring.style.transform = `scale(${s})`;
                ring.style.borderColor = color;
                ring.style.opacity = o;
            });
        }, 400);
    }

    function stopRings() {
        if (ringInterval) clearInterval(ringInterval);
        rings.forEach(ring => {
            ring.style.borderColor = 'transparent';
            ring.style.opacity = '0';
        });
    }

    // ===== Controls =====
    function toggleMute() {
        isMuted = !isMuted;
        muteIcon.textContent = isMuted ? 'mic_off' : 'mic';
        muteBtn.classList.toggle('bg-red-500/50', isMuted);
        
        if (isMuted && state === 'listening') {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            clearInterval(analyserInterval);
            callStatus.textContent = 'Muted';
            voiceHint.textContent = 'Unmute to speak';
            stopRings();
            resetBars();
        } else if (!isMuted && state !== 'speaking') {
            startListening();
        }
    }

    function toggleSpeaker() {
        isSpeakerOn = !isSpeakerOn;
        speakerIcon.textContent = isSpeakerOn ? 'volume_up' : 'volume_off';
        speakerBtn.classList.toggle('bg-white/30', !isSpeakerOn);
    }

    // ===== Event Listeners =====
    startCallBtn.addEventListener('click', startCall);
    endCallBtn.addEventListener('click', endCall);
    muteBtn.addEventListener('click', toggleMute);
    speakerBtn.addEventListener('click', toggleSpeaker);

    // ===== Settings =====
    function loadVoices() {
        voices = window.speechSynthesis.getVoices();
        const voiceSelect = $('voice-select');
        voiceSelect.innerHTML = '';
        voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.voiceURI;
            opt.textContent = `${v.name} (${v.lang})`;
            if (v.voiceURI === localStorage.getItem('voiceURI')) opt.selected = true;
            voiceSelect.appendChild(opt);
        });
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
    }
    loadVoices();

    $('rate-range').value = localStorage.getItem('speechRate') || 1.0;
    $('pitch-range').value = localStorage.getItem('speechPitch') || 1.0;
    $('rate-value').textContent = $('rate-range').value;
    $('pitch-value').textContent = $('pitch-range').value;

    $('settings-btn').addEventListener('click', () => $('settings-modal').classList.remove('hidden'));
    $('save-settings').addEventListener('click', () => $('settings-modal').classList.add('hidden'));
    $('modal-backdrop').addEventListener('click', () => $('settings-modal').classList.add('hidden'));

    $('rate-range').addEventListener('input', (e) => {
        localStorage.setItem('speechRate', e.target.value);
        $('rate-value').textContent = e.target.value;
    });

    $('pitch-range').addEventListener('input', (e) => {
        localStorage.setItem('speechPitch', e.target.value);
        $('pitch-value').textContent = e.target.value;
    });

    $('voice-select').addEventListener('change', (e) => {
        localStorage.setItem('voiceURI', e.target.value);
    });

    $('test-voice').addEventListener('click', () => {
        const u = new SpeechSynthesisUtterance("Hello! I am your AI English coach.");
        u.rate = parseFloat($('rate-range').value);
        u.pitch = parseFloat($('pitch-range').value);
        const v = voices.find(v => v.voiceURI === $('voice-select').value);
        if (v) u.voice = v;
        window.speechSynthesis.speak(u);
    });
});
</script>

<style>
    .pt-safe { padding-top: env(safe-area-inset-top); }
</style>
{% endblock %}
